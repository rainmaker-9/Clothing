{% extends "layout.html" %}
{% block title %}Cart{% endblock %}
{% block head %}
{{ super() }}
{% endblock %}
{% block content %}
<div class="container py-3 py-md-5">
  <form id="frmCheckout" class="row g-3">
    {% if cartProducts %}
    {% for product in cartProducts %}
    <div class="col-md-6 col-xl-5 col-xxl-4">
      <div class="card card-body shadow border-0">
        <div class="row g-3">
          <div class="col-3 col-md-4">
            <img src="/static/{{product.thumbnail}}" alt="{{product.title}}" class="d-block w-100" />
          </div>
          <div class="col-9 col-md-8">
            <div class="d-flex flex-column justify-content-between h-100">
              <div>
                <div class="d-flex justify-content-between align-items-center">
                  <p class="fw-bold mb-0"><a href="{{ url_for('product', product_id=product.id) }}"
                      class="link-danger">{{ product.title }}</a></p>
                  <a class="link-danger small btn-remove-from-cart" href="#" data-cart-item="{{product.spec}}">
                    <i class="fa-solid fa-trash-can"></i></a>
                </div>
                <p class="mb-0" id="product-price">{{ product.price|currency_format }}</p>
                <p class="mb-0">Size: {{ product.size }}</p>
                <p class="mb-0">Color: {{ product.color }}</p>
              </div>
              <div class="col-md-8 col-xxl-6">
                <div class="d-flex gap-2 align-items-center">
                  <label for="">Quantity</label>
                  <select class="form-select form-select-sm" data-cart-item="{{product.spec}}">
                    {% if product.stock > 1 %}
                    {% for qnt in range(1, product.stock + 1) %}
                    <option value="{{qnt}}">{{qnt}}</option>
                    {% endfor %}
                    {% endif %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <div class="col-12">
      {% if addressCount %}
      <button type="submit" class="btn btn-primary btn-lg rounded-1">
        <i class="fa-solid fa-cart-arrow-down me-2"></i>Checkout</button>
      {% else %}
      <p class="mb-0 lead">You have not added any shipping address yet. <a class="link-danger"
          href="{{ url_for('profile') }}">Click here to add one</a></p>
      {% endif %}
    </div>
    {% else %}
    <div class="col-12 text-center">
      <h1 class="text-danger"><i class="fa-solid fa-sad-tear"></i></h1>
      <h3 class="fw-bold text-danger">No products in your cart</h3>
      <a href="{{ url_for('shop') }}" class="btn btn-success btn-lg rounded-1"><i
          class="fa-solid fa-store-alt me-2"></i>Shop now!</a>
    </div>
    {% endif %}
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
  const removeFromCartButtons = document.querySelectorAll('.btn-remove-from-cart')
  if (removeFromCartButtons.length) {
    removeFromCartButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const cartItem = e.currentTarget.dataset.cartItem;
        if (cartItem) {
          const confirm = await showConfirm('Are you sure', 'Are you sure you want to remove this product from cart?', 'Yes', 'danger', 'No', 'secondary')
          if (confirm.isConfirmed) {
            const data = new FormData;
            data.append('cartItem', cartItem)
            fetch('/remove-cart-item', { method: "POST", body: data }).then(response => {
              if (!response.ok) {
                throw new Error(response.statusText)
              }
              response.json().then(result => {
                Swal.fire({
                  title: result.status ? 'Success' : 'Error!',
                  text: result.message,
                  icon: result.status ? 'success' : 'error',
                  confirmButtonText: 'OK'
                }).then(res => {
                  if (result.status) {
                    location.reload();
                  }
                })
              })
            })
          }
        }
      })
    })
  }

  const quantitySelects = document.querySelectorAll('.form-select');
  if (quantitySelects.length) {
    quantitySelects.forEach(function (select) {
      select.addEventListener('change', function (e) {
        const productPrice = select.closest('.card').querySelector('#product-price');
        if (productPrice && e.target.dataset.cartItem && e.target.value) {
          const data = new FormData;
          data.append('spec-id', e.target.dataset.cartItem)
          data.append('quantity', e.target.value)
          fetch('/get-calc-product-price', { method: "POST", body: data }).then(response => {
            if (!response.ok) throw new Error(response.statusText)
            response.json().then(result => {
              if (result.status) {
                productPrice.textContent = result.price;
              } else {
                Swal.fire({
                  title: 'Error!',
                  text: result.message,
                  icon: 'error',
                  confirmButtonText: 'OK'
                }).then(() => {
                  e.target.value = '1'
                  e.target.dispatchEvent(new Event('change'))
                })
              }
            })
          })
        }
      });
    });
  }

  const frmCheckout = document.querySelector('#frmCheckout')

  if (frmCheckout) {
    frmCheckout.addEventListener('submit', (e) => {
      e.preventDefault();
      if (quantitySelects.length) {
        const data = new FormData;
        const products = [];
        quantitySelects.forEach(select => {
          const prod = new Product(select.dataset.cartItem, select.value)
          products.push(prod);
        })
        data.append('cart-items', JSON.stringify(products))
        fetch('/checkout', { method: "POST", body: data }).then(response => {

        })
      }
    })
  }

  function Product(spec_id, quantity) {
    return {
      spec: spec_id,
      qnt: quantity
    }
  }
</script>
{% endblock %}